# Order Grouping System - Architecture Diagram

## Complete Workflow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ORDER GROUPING SYSTEM FLOW                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE 0: ORDER CREATION (Immediate)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    POST /api/orders/create
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Validate Order      â”‚
    â”‚  Calculate Pricing   â”‚
    â”‚  Set soldeSimple     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Set Processing Delay (5-10 min random)  â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
    â”‚  processingDelay = random(5, 10)         â”‚
    â”‚  scheduledFor = now + processingDelay    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Create Order in Database                â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
    â”‚  status: 'pending'                       â”‚
    â”‚  orderType: 'A1' (default)               â”‚
    â”‚  isGrouped: false                        â”‚
    â”‚  groupedOrders: []                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Send Notification    â”‚
    â”‚ to Deliverers        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    ğŸ“ RETURN Response
       {
         order: { _id, processingDelay, scheduledFor, ... },
         message: "Order created successfully"
       }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE 1: DELAY WINDOW (5-10 minutes)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â±ï¸ TIME PASSES (5-10 minutes)
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Order in Database                   â”‚
    â”‚ status: 'pending'                   â”‚
    â”‚ processingDelay: 7 (minutes)        â”‚
    â”‚ scheduledFor: 2024-01-15T14:07:00Z  â”‚
    â”‚ isGrouped: false                    â”‚
    â”‚ â† NOT ELIGIBLE FOR GROUPING YET â†’   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE 2: SCHEDULER CYCLE (Every 60 seconds)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸš€ Server.js initialization
       â”‚
       â””â”€â†’ startGroupingScheduler()
           â”‚
           â”œâ”€ Set interval(runGroupingCycle, 60 * 1000)
           â”œâ”€ Call runGroupingCycle() immediately
           â””â”€ Log "ğŸš€ Order Grouping Scheduler started"

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           60-SECOND CYCLE (Every minute)                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
    â”‚  â”‚  STEP 1: Release Orders          â”‚                       â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚                       â”‚
    â”‚  â”‚  releaseOrdersFromDelay()        â”‚                       â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚                       â”‚
    â”‚  â”‚  â€¢ Find orders where:            â”‚                       â”‚
    â”‚  â”‚    scheduledFor â‰¤ Date.now()     â”‚                       â”‚
    â”‚  â”‚  â€¢ Update those orders:          â”‚                       â”‚
    â”‚  â”‚    processingDelay = null        â”‚                       â”‚
    â”‚  â”‚    scheduledFor = null           â”‚                       â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
    â”‚           â”‚                                                  â”‚
    â”‚           â–¼                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚  â”‚  STEP 2: Find Grouping Candidates               â”‚       â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚       â”‚
    â”‚  â”‚  findGroupingCandidates(hoursBack=1)            â”‚       â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚       â”‚
    â”‚  â”‚  Query orders matching:                         â”‚       â”‚
    â”‚  â”‚  â€¢ status = 'pending'                           â”‚       â”‚
    â”‚  â”‚  â€¢ isGrouped = false                            â”‚       â”‚
    â”‚  â”‚  â€¢ orderType IN ['A1', 'A2', 'A3']              â”‚       â”‚
    â”‚  â”‚  â€¢ scheduledFor = null (delay expired)          â”‚       â”‚
    â”‚  â”‚  â€¢ createdAt â‰¥ (now - 1 hour)                   â”‚       â”‚
    â”‚  â”‚  âœ“ Populated with client & provider data        â”‚       â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
    â”‚           â”‚                                                  â”‚
    â”‚           â–¼                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚  â”‚  STEP 3A: Attempt A3 Grouping (Priority)      â”‚         â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚
    â”‚  â”‚  For EACH candidate order:                    â”‚         â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
    â”‚  â”‚  â”‚ 1. Find 2 compatible partners           â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚                                          â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚ 2. Validate distances:                  â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Provider A â†” B: â‰¤6km âœ“             â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Provider A â†” C: â‰¤6km âœ“             â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Provider B â†” C: â‰¤6km âœ“             â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Delivery A: â‰¤3km âœ“                 â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Delivery B: â‰¤3km âœ“                 â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Delivery C: â‰¤3km âœ“                 â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚                                          â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚ 3. If valid: groupOrdersIntoA3()        â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Set orderType = 'A3'               â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Set isGrouped = true               â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Set groupedOrders references       â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Calculate soldeTriple = 1.50â‚¬      â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Call notifyGroupFormed()           â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚                                          â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚ 4. Mark all 3 as processed              â”‚ â”‚         â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚           â”‚                                                  â”‚
    â”‚           â–¼                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚  â”‚  STEP 3B: Attempt A2 Grouping (Secondary)    â”‚         â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚
    â”‚  â”‚  For EACH unprocessed candidate:             â”‚         â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
    â”‚  â”‚  â”‚ 1. Find 1 compatible partner            â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚                                          â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚ 2. Validate distances:                  â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Provider A â†” B: â‰¤6km âœ“             â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Delivery A: â‰¤3km âœ“                 â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    â€¢ Delivery B: â‰¤3km âœ“                 â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚                                          â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚ 3. If valid: groupOrdersIntoA2()        â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Set orderType = 'A2'               â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Set isGrouped = true               â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Set groupedOrders references       â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Calculate soldeDual = 4.50â‚¬        â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚    âœ“ Call notifyGroupFormed()           â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚                                          â”‚ â”‚         â”‚
    â”‚  â”‚  â”‚ 4. Mark both as processed               â”‚ â”‚         â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚           â”‚                                                  â”‚
    â”‚           â–¼                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚  â”‚  STEP 4: Send Deliverer Notifications        â”‚         â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚         â”‚
    â”‚  â”‚  notifyGroupFormed(groupIds, soldeAmount)    â”‚         â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚         â”‚
    â”‚  â”‚  For EACH group formed:                      â”‚         â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
    â”‚  â”‚  â”‚ â€¢ Query online deliverers            â”‚    â”‚         â”‚
    â”‚  â”‚  â”‚ â€¢ Send FCM/Expo push notification:   â”‚    â”‚         â”‚
    â”‚  â”‚  â”‚   {                                  â”‚    â”‚         â”‚
    â”‚  â”‚  â”‚     title: "ğŸšš Nouveau Groupe...",   â”‚    â”‚         â”‚
    â”‚  â”‚  â”‚     body: "Solde: 4.50â‚¬",            â”‚    â”‚         â”‚
    â”‚  â”‚  â”‚     data: { groupIds }               â”‚    â”‚         â”‚
    â”‚  â”‚  â”‚   }                                  â”‚    â”‚         â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚           â”‚                                                  â”‚
    â”‚           â–¼                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚  â”‚  CYCLE COMPLETE                               â”‚         â”‚
    â”‚  â”‚  â€¢ A3 groups formed: X                         â”‚         â”‚
    â”‚  â”‚  â€¢ A2 groups formed: Y                         â”‚         â”‚
    â”‚  â”‚  â€¢ Deliverers notified: Z                      â”‚         â”‚
    â”‚  â”‚  â€¢ Wait 60 seconds, repeat...                  â”‚         â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚                                                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE 3: ORDER STATE AFTER GROUPING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ORDER A (A2 Group Example)           ORDER B (Partner)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ _id: ObjectId("123")    â”‚         â”‚ _id: ObjectId("456")    â”‚
    â”‚ status: 'pending'       â”‚         â”‚ status: 'pending'       â”‚
    â”‚ orderType: 'A2'         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ orderType: 'A2'         â”‚
    â”‚ isGrouped: true         â”‚         â”‚ isGrouped: true         â”‚
    â”‚ groupedOrders: [456]    â”‚         â”‚ groupedOrders: [123]    â”‚
    â”‚ processingDelay: null   â”‚         â”‚ processingDelay: null   â”‚
    â”‚ scheduledFor: null      â”‚         â”‚ scheduledFor: null      â”‚
    â”‚ soldeSimple: 2.50â‚¬      â”‚         â”‚ soldeSimple: 2.50â‚¬      â”‚
    â”‚ soldeDual: 4.50â‚¬ â† PAID â”‚         â”‚ soldeDual: 4.50â‚¬ â† PAID â”‚
    â”‚ soldeTriple: 0          â”‚         â”‚ soldeTriple: 0          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE 4: DELIVERY (Grouped)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Deliverer accepts A2 group
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Deliver both orders together      â”‚
    â”‚ â€¢ Pick up from Provider A & B     â”‚
    â”‚ â€¢ Deliver to Client A & B         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Mark both orders 'delivered'      â”‚
    â”‚ updateOrderStatus(orderId, 'delivered')
    â”‚ â€¢ Balance finalized               â”‚
    â”‚ â€¢ solde locked at 4.50â‚¬ each      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SERVER LIFECYCLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸš€ SERVER START
       â”‚
       â”œâ”€ Connect MongoDB
       â”œâ”€ Initialize Express
       â”œâ”€ Setup routes
       â”œâ”€ Setup Socket.IO
       â”‚
       â””â”€ server.listen(PORT)
           â”‚
           â””â”€ startGroupingScheduler()
              â”œâ”€ Initialize 60-second interval
              â”œâ”€ Run first cycle immediately
              â””â”€ Log: "ğŸš€ Order Grouping Scheduler started"

    â¸ï¸  GRACEFUL SHUTDOWN (SIGTERM / SIGINT)
       â”‚
       â”œâ”€ stopGroupingScheduler()
       â”‚  â”œâ”€ Clear interval
       â”‚  â””â”€ Log: "â¹ï¸ Scheduler stopped"
       â”‚
       â”œâ”€ Close server
       â”‚  â””â”€ Log: "âŒ HTTP server closed"
       â”‚
       â””â”€ Close MongoDB connection
          â””â”€ Log: "âŒ MongoDB connection closed"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DISTANCE VALIDATION (Haversine Formula)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Provider A (lat1, lon1)
           â”‚
           â”‚  calculateDistance(lat1, lon1, lat2, lon2)
           â”‚  â”œâ”€ R = 6371 km (Earth radius)
           â”‚  â”œâ”€ dLat = (lat2 - lat1) * Ï€/180
           â”‚  â”œâ”€ dLon = (lon2 - lon1) * Ï€/180
           â”‚  â”œâ”€ a = sinÂ²(dLat/2) + cos(lat1)Â·cos(lat2)Â·sinÂ²(dLon/2)
           â”‚  â”œâ”€ c = 2Â·atan2(âˆša, âˆš(1-a))
           â”‚  â””â”€ distance = R * c (in km)
           â”‚
           â–¼
    Provider B (lat2, lon2)
    
    Result: 5.2 km
            â†“
    âœ“ VALID (â‰¤6km) â†’ Include in grouping

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DATABASE INDEXES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    PRIMARY INDEX (for grouping queries):
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ db.orders.createIndex({                        â”‚
    â”‚   status: 1,                                   â”‚
    â”‚   orderType: 1,                                â”‚
    â”‚   isGrouped: 1,                                â”‚
    â”‚   scheduledFor: 1                              â”‚
    â”‚ })                                             â”‚
    â”‚                                                â”‚
    â”‚ Query: Find pending, ungrouped, released ordersâ”‚
    â”‚ Performance: O(1) lookup â†’ O(n) filter         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    SECONDARY INDEX (for provider/zone queries):
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ db.orders.createIndex({                        â”‚
    â”‚   provider: 1,                                 â”‚
    â”‚   zone: 1,                                     â”‚
    â”‚   scheduledFor: 1                              â”‚
    â”‚ })                                             â”‚
    â”‚                                                â”‚
    â”‚ Query: Find provider's pending orders          â”‚
    â”‚ Performance: Fast zone-based filtering         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SOLDE CALCULATION BREAKDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    SINGLE ORDER (A1)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    appFee: 5.00â‚¬
         â”‚
         â””â”€ soldeSimple = appFee = 5.00â‚¬

    A2 GROUP (2 orders)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Order A appFee: 5.00â‚¬     Order B appFee: 4.00â‚¬
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â””â”€ soldeDual = (5.00 + 4.00) * 0.90 = 8.10â‚¬
                       Distributed: 4.05â‚¬ each

    A3 GROUP (3 orders)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    A: 5.00â‚¬    B: 4.00â‚¬    C: 3.50â‚¬
         â”‚           â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â””â”€ soldeTriple = (5.00 + 4.00 + 3.50) * 0.85 = 11.475â‚¬
                        Distributed: 3.825â‚¬ each

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MONITORING & OBSERVABILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    SCHEDULER STATUS CHECK
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    getSchedulerStatus()
         â”‚
         â”œâ”€ running: true/false
         â”œâ”€ intervalMs: 60000
         â”œâ”€ lastCycle: timestamp
         â””â”€ cycleCount: number

    CYCLE LOGS (Pattern: ğŸ“¦ âœ… ğŸšš)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ“¦ Grouping cycle started
    ğŸ” Found 5 candidates for grouping
    âœ… A3 group formed: [id1, id2, id3]
    âœ… A2 group formed: [id4, id5]
    ğŸšš Notified 8 deliverers
    ğŸ“¦ Grouping cycle completed

    DATABASE MONITORING
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    db.orders.countDocuments({ isGrouped: true })  â†’ Grouped orders count
    db.orders.countDocuments({ processingDelay: { $exists: true }})  â†’ In delay
    db.orders.aggregate([...])  â†’ Advanced analytics

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
END OF WORKFLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      COMPONENT DEPENDENCY GRAPH                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    server.js
      â”‚
      â”œâ”€â†’ orderGroupingScheduler
      â”‚     â”‚
      â”‚     â”œâ”€â†’ orderGroupingService
      â”‚     â”‚     â”‚
      â”‚     â”‚     â”œâ”€â†’ balanceCalculator (for solde calculations)
      â”‚     â”‚     â”œâ”€â†’ Order (MongoDB model)
      â”‚     â”‚     â”œâ”€â†’ User (for deliverer queries)
      â”‚     â”‚     â””â”€â†’ distanceCalculator (utils)
      â”‚     â”‚           â””â”€â†’ Haversine distance logic
      â”‚     â”‚
      â”‚     â””â”€â†’ pushNotificationService
      â”‚           â””â”€â†’ FCM/Expo notifications
      â”‚
      â”œâ”€â†’ orderController
      â”‚     â”‚
      â”‚     â”œâ”€â†’ balanceCalculator (on order creation)
      â”‚     â””â”€â†’ Order (MongoDB model)
      â”‚
      â””â”€â†’ Socket.IO (real-time events)

    Client Application
      â”‚
      â”œâ”€â†’ POST /api/orders/create (orderController.createOrder)
      â”‚     â””â”€â†’ Response includes processingDelay & scheduledFor
      â”‚
      â””â”€â†’ FCM/Expo Push Notifications (from notifyGroupFormed)
            â””â”€â†’ "ğŸšš Nouveau Groupe de Commandes"

    Database (MongoDB)
      â”‚
      â”œâ”€â†’ Order collection (with indexes)
      â”œâ”€â†’ User collection (for deliverer data)
      â””â”€â†’ Scheduler index queries

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## State Transition Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ORDER STATE TRANSITIONS                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    [CREATED]
       â”‚
       â”œâ”€ status: 'pending'
       â”œâ”€ orderType: 'A1'
       â”œâ”€ isGrouped: false
       â”œâ”€ processingDelay: 7 (minutes)
       â””â”€ scheduledFor: 2024-01-15T14:07:00Z
       â”‚
       â””â”€â”€(5-10 minutes elapse)â”€â”€â†’
       
    [DELAY EXPIRED]
       â”‚
       â”œâ”€ status: 'pending'
       â”œâ”€ orderType: 'A1'
       â”œâ”€ isGrouped: false
       â”œâ”€ processingDelay: null
       â””â”€ scheduledFor: null
       â”‚
       â””â”€â”€(scheduler finds partner)â”€â”€â†’
       
    [GROUPED as A2/A3]
       â”‚
       â”œâ”€ status: 'pending'
       â”œâ”€ orderType: 'A2' or 'A3'
       â”œâ”€ isGrouped: true
       â”œâ”€ groupedOrders: [partnerId]
       â”œâ”€ soldeDual/Triple: calculated
       â”‚
       â””â”€â”€(deliverer accepts)â”€â”€â†’
       
    [ASSIGNED]
       â”‚
       â”œâ”€ status: 'assigned'
       â”œâ”€ deliverer_id: set
       â”‚
       â””â”€â”€(deliverer delivers)â”€â”€â†’
       
    [DELIVERED]
       â”‚
       â”œâ”€ status: 'delivered'
       â”œâ”€ deliveryTime: timestamp
       â”œâ”€ solde: finalized
       â””â”€ [END STATE]

```
